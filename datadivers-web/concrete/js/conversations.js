!function(a,b){"use strict";a.extend(a.fn,{concreteConversation:function(b){return this.each(function(){var c=a(this),e=c.data("concreteConversation");e||c.data("concreteConversation",e=new d(c,b))})}});var c={Confirm_remove_message:"Remove this message? Replies to it will not be removed.",Confirm_mark_as_spam:"Are you sure you want to flag this message as spam?",Warn_currently_editing:"Please complete or cancel the current message editing session before editing this message.",Unspecified_error_occurred:"An unspecified error occurred.",Error_deleting_message:"Something went wrong while deleting this message, please refresh and try again.",Error_flagging_message:"Something went wrong while flagging this message, please refresh and try again."};a.fn.concreteConversation.localize=function(b){a.extend(!0,c,b)};var d=function(a,b){this.publish("beforeInitializeConversation",{element:a,options:b}),this.init(a,b),this.publish("initializeConversation",{element:a,options:b})};d.fn=d.prototype={publish:function(a,c){c=c||{},c.ConcreteConversation=this,b.ConcreteEvent.publish(a,c)},init:function(c,d){var e=this;e.$element=c,e.options=a.extend({method:"ajax",paginate:!1,displayMode:"threaded",itemsPerPage:-1,activeUsers:[],uninitialized:!0},d);var f=""!=e.options.posttoken?1:0,g=e.options.paginate?1:0,h=e.options.orderBy,i=e.options.enableOrdering,j=e.options.displayPostingForm,k=e.options.enableCommentRating,l=e.options.commentRatingUserID,m=e.options.commentRatingIP,n=e.options.addMessageLabel?e.options.addMessageLabel:"",o=e.options.dateFormat,p=e.options.customDateFormat,q=e.options.blockAreaHandle,r=(e.options.maxFiles,e.options.maxFileSize,e.options.fileExtensions,e.options.attachmentsEnabled),s=e.options.attachmentOverridesEnabled;"ajax"==e.options.method?a.post(CCM_TOOLS_PATH+"/conversations/view_ajax",{cnvID:e.options.cnvID,cID:e.options.cID,blockID:e.options.blockID,enablePosting:f,itemsPerPage:e.options.itemsPerPage,addMessageLabel:n,paginate:g,displayMode:e.options.displayMode,orderBy:h,enableOrdering:i,displayPostingForm:j,enableCommentRating:k,commentRatingUserID:l,commentRatingIP:m,dateFormat:o,customDateFormat:p,blockAreaHandle:q,attachmentsEnabled:r,attachmentOverridesEnabled:s},function(c){var d=b.obj;b.obj=e,e.$element.empty().append(c);var f=b.location.hash.match(/^#cnv([0-9]+)Message[0-9]+$/);if(null!==f&&f[1]==e.options.cnvID){var g=a("a"+b.location.hash).offset();a("html, body").animate({scrollTop:g.top},800,"linear")}b.obj=d,e.attachBindings(),e.publish("conversationLoaded")}):(e.attachBindings(),e.finishSetup(),e.publish("conversationLoaded"))},mentionList:function(b,c,d){var e=this;if(c){if(e.dropdown.parent.css({top:c.y,left:c.x}),0==b.length)return e.dropdown.handle.dropdown("toggle"),e.dropdown.parent.remove(),e.dropdown.active=!1,void(e.dropdown.activeItem=-1);e.dropdown.list.empty(),b.slice(0,20).map(function(b){var c=a("<li/>"),f=a("<a/>").appendTo(c).text(b.getName());f.click(function(){ConcreteEvent.fire("ConversationMentionSelect",{obj:e,item:b},d)}),c.appendTo(e.dropdown.list)}),e.dropdown.active||(e.dropdown.active=!0,e.dropdown.activeItem=-1,e.dropdown.parent.appendTo(e.$element),e.dropdown.handle.dropdown("toggle")),e.dropdown.activeItem>=0&&e.dropdown.list.children().eq(e.dropdown.activeItem).addClass("active")}},attachSubscriptionBindings:function(){a("a[data-conversation-subscribe]").magnificPopup({type:"ajax",callbacks:{updateStatus:function(b){if("ready"==b.status){var c=a("form[data-conversation-form=subscribe]");a("button").on("click",c,function(b){b.preventDefault(),b.stopPropagation(),a.ajax({url:c.attr("action"),dataType:"json",success:function(b){b.subscribed?(a("[data-conversation-subscribe=subscribe]").hide(),a("[data-conversation-subscribe=unsubscribe]").show()):(a("[data-conversation-subscribe=unsubscribe]").hide(),a("[data-conversation-subscribe=subscribe]").show()),a.magnificPopup.close()}})})}},beforeOpen:function(){this.st.mainClass="mfp-zoom-in"}},closeOnContentClick:!0,midClick:!0})},attachBindings:function(){var d=this;d.$element.unbind(".cnv"),d.options.uninitialized&&(d.options.uninitialized=!1,ConcreteEvent.bind("ConversationMention",function(a,b){d.mentionList(b.items,b.coordinates||!1,b.bindTo||d.$element.get(0))},d.$element.get(0)),d.dropdown={},d.dropdown.parent=a("<div/>").css({position:"absolute",height:0,width:0}),d.dropdown.active=!1,d.dropdown.handle=a("<a/>").appendTo(d.dropdown.parent),d.dropdown.list=a("<ul/>").addClass("dropdown-menu").appendTo(d.dropdown.parent),d.dropdown.handle.dropdown(),ConcreteEvent.bind("ConversationTextareaKeydownUp",function(a){-1==d.dropdown.activeItem&&(d.dropdown.activeItem=d.dropdown.list.children().length),d.dropdown.activeItem-=1,d.dropdown.activeItem+=d.dropdown.list.children().length,d.dropdown.activeItem%=d.dropdown.list.children().length,d.dropdown.list.children().filter(".active").removeClass("active").end().eq(d.dropdown.activeItem).addClass("active")},d.$element.get(0)),ConcreteEvent.bind("ConversationTextareaKeydownDown",function(a){d.dropdown.activeItem+=1,d.dropdown.activeItem+=d.dropdown.list.children().length,d.dropdown.activeItem%=d.dropdown.list.children().length,d.dropdown.list.children().filter(".active").removeClass("active").end().eq(d.dropdown.activeItem).addClass("active")},d.$element.get(0)),ConcreteEvent.bind("ConversationTextareaKeydownEnter",function(a){d.dropdown.list.children().filter(".active").children("a").click()},d.$element.get(0)),ConcreteEvent.bind("ConversationPostError",function(b,c){var d=c.form,e=c.messages,f="";a.each(e,function(a,b){f+=b+"<br>"}),d.find("div.ccm-conversation-errors").html(f).show()}),ConcreteEvent.bind("ConversationSubmitForm",function(a,b){b.form.find("div.ccm-conversation-errors").hide()}));var e=d.options.paginate?1:0,f=""!=d.options.posttoken?1:0,g=d.options.addMessageLabel?d.options.addMessageLabel:"";d.$replyholder=d.$element.find("div.ccm-conversation-add-reply"),d.$newmessageform=d.$element.find("div.ccm-conversation-add-new-message form"),d.$deleteholder=d.$element.find("div.ccm-conversation-delete-message"),d.$attachmentdeleteholder=d.$element.find("div.ccm-conversation-delete-attachment"),d.$permalinkholder=d.$element.find("div.ccm-conversation-message-permalink"),d.$messagelist=d.$element.find("div.ccm-conversation-message-list"),d.$messagecnt=d.$element.find(".ccm-conversation-message-count"),d.$postbuttons=d.$element.find("[data-submit=conversation-message]"),d.$sortselect=d.$element.find("select[data-sort=conversation-message-list]"),d.$loadmore=d.$element.find("[data-load-page=conversation-message-list]"),d.$messages=d.$element.find("div.ccm-conversation-messages"),d.$messagerating=d.$element.find("span.ccm-conversation-message-rating"),d.$element.on("click.cnv","[data-submit=conversation-message]",function(b){b.preventDefault(),d.submitForm(a(this))}),d.$element.on("click.cnv","[data-submit=update-conversation-message]",function(){return d.submitUpdateForm(a(this)),!1}),this.attachSubscriptionBindings();var h=1;d.$element.on("click.cnv","a[data-toggle=conversation-reply]",function(b){b.preventDefault(),a(".ccm-conversation-attachment-container").each(function(){a(this).is(":visible")&&a(this).toggle()});var c=d.$replyholder.appendTo(a(this).closest("div[data-conversation-message-id]"));return c.attr("data-form","conversation-reply").show(),c.find("[data-submit=conversation-message]").attr("data-post-parent-id",a(this).attr("data-post-parent-id")),c.attr("rel","new-reply"+h),h++,!1}),a(".ccm-conversation-attachment-container").hide(),a(".ccm-conversation-add-new-message .ccm-conversation-attachment-toggle").off("click.cnv").on("click.cnv",function(b){b.preventDefault(),a(".ccm-conversation-add-reply .ccm-conversation-attachment-container").is(":visible")&&a(".ccm-conversation-add-reply .ccm-conversation-attachment-container").toggle(),a(".ccm-conversation-add-new-message .ccm-conversation-attachment-container").toggle()}),a(".ccm-conversation-add-reply .ccm-conversation-attachment-toggle").off("click.cnv").on("click.cnv",function(b){b.preventDefault(),a(".ccm-conversation-add-new-message .ccm-conversation-attachment-container").is(":visible")&&a(".ccm-conversation-add-new-message .ccm-conversation-attachment-container").toggle(),a(".ccm-conversation-add-reply .ccm-conversation-attachment-container").toggle()}),d.$element.on("click.cnv","a[data-submit=delete-conversation-message]",function(){var e=a(this);return d.$deletedialog=d.$deleteholder.clone(),d.$deletedialog.dialog?d.$deletedialog.dialog({modal:!0,dialogClass:"ccm-conversation-dialog",title:d.$deleteholder.attr("data-dialog-title"),buttons:[{text:d.$deleteholder.attr("data-cancel-button-title"),"class":"btn pull-left",click:function(){d.$deletedialog.dialog("close")}},{text:d.$deleteholder.attr("data-confirm-button-title"),"class":"btn pull-right btn-danger",click:function(){d.deleteMessage(e.attr("data-conversation-message-id"))}}]}):b.confirm(c.Confirm_remove_message)&&d.deleteMessage(e.attr("data-conversation-message-id")),!1}),d.$element.on("click.cnv","a[data-submit=flag-conversation-message]",function(){var e=a(this);return b.confirm(c.Confirm_mark_as_spam)&&d.flagMessage(e.attr("data-conversation-message-id")),!1}),d.$element.on("click.cnv","a[data-load=edit-conversation-message]",function(){if(a(".ccm-conversation-edit-message").is(":visible"))return b.alert(c.Warn_currently_editing),!1;var e=a(this);d.editMessage(e.attr("data-conversation-message-id"))}),d.$element.on("change.cnv","select[data-sort=conversation-message-list]",function(){d.$messagelist.load(CCM_TOOLS_PATH+"/conversations/view_ajax",{cnvID:d.options.cnvID,task:"get_messages",cID:d.options.cID,blockID:d.options.blockID,enablePosting:f,displayMode:d.options.displayMode,itemsPerPage:d.options.itemsPerPage,paginate:e,addMessageLabel:g,orderBy:a(this).val(),enableOrdering:d.options.enableOrdering,displayPostingForm:d.options.displayPostingForm,enableCommentRating:d.options.enableCommentRating,dateFormat:d.options.dateFormat,customDateFormat:d.options.customDateFormat,blockAreaHandle:d.options.blockAreaHandle,attachmentsEnabled:d.options.attachmentsEnabled,attachmentOverridesEnabled:d.options.attachmentOverridesEnabled},function(b){d.$replyholder.appendTo(d.$element),a(".ccm-conversation-messages .dropdown-toggle").dropdown(),d.attachBindings()})}),d.$element.on("click.cnv",".image-popover-hover",function(){a.magnificPopup.open({items:{src:a(this).attr("data-full-image"),type:"image",verticalFit:!0}})}),d.$element.on("click.cnv","[data-load-page=conversation-message-list]",function(){var b=parseInt(d.$loadmore.attr("data-next-page")),c=parseInt(d.$loadmore.attr("data-total-pages")),e={cnvID:d.options.cnvID,cID:d.options.cID,blockID:d.options.blockID,itemsPerPage:d.options.itemsPerPage,displayMode:d.options.displayMode,blockAreaHandle:d.options.blockAreaHandle,enablePosting:f,addMessageLabel:g,page:b,orderBy:d.$sortselect.val(),enableCommentRating:d.options.enableCommentRating,dateFormat:d.options.dateFormat,customDateFormat:d.options.customDateFormat,attachmentsEnabled:d.options.attachmentsEnabled,attachmentOverridesEnabled:d.options.attachmentOverridesEnabled};a.ajax({type:"post",data:e,url:CCM_TOOLS_PATH+"/conversations/message_page",success:function(e){d.$messages.append(e),a(".ccm-conversation-messages .dropdown-toggle").dropdown(),b+1>c?d.$loadmore.hide():d.$loadmore.attr("data-next-page",b+1)}})}),d.$element.on("click.cnv",".conversation-rate-message",function(){var b=a(this).closest("[data-conversation-message-id]").attr("data-conversation-message-id"),c=a(this).attr("data-conversation-rating-type");d.$messagerating.load(CCM_TOOLS_PATH+"/conversations/rate");var e={cnvID:d.options.cnvID,cID:d.options.cID,blockID:d.options.blockID,cnvMessageID:b,cnvRatingTypeHandle:c,commentRatingUserID:d.options.commentRatingUserID,commentRatingIP:d.options.commentRatingIP};a.ajax({type:"post",data:e,url:CCM_TOOLS_PATH+"/conversations/rate",success:function(c){a('span[data-message-rating="'+b+'"]').load(CCM_TOOLS_PATH+"/conversations/get_rating",{cnvMessageID:b})}})}),d.$element.on("click.cnv","a.share-popup",function(){var c=void 0!=b.screenLeft?b.screenLeft:screen.left,d=void 0!=b.screenTop?b.screenTop:screen.top,e=b.innerWidth?b.innerWidth:document.documentElement.clientWidth?document.documentElement.clientWidth:screen.width,f=b.innerHeight?b.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:screen.height,g=e/2-300+c,h=f/2-125+d;return b.open(a(this).attr("href"),"cnvSocialShare","left:"+g+",top:"+h+",height=250,width=600,toolbar=no,status=no"),!1}),d.$element.on("click.cnv","a.share-permalink",function(){var c=a(this),e=c.attr("rel");d.$permalinkdialog=d.$permalinkholder.clone();var f=a("<textarea readonly>").text(decodeURIComponent(e));return d.$permalinkdialog.append(f),f.click(function(){var c=a(this);c.select(),b.setTimeout(function(){c.select()},1),c.mouseup(function(){return c.unbind("mouseup"),!1})}),d.$permalinkdialog.dialog&&d.$permalinkdialog.dialog({modal:!0,dialogClass:"ccm-conversation-dialog",title:d.$permalinkholder.attr("data-dialog-title"),buttons:[{text:d.$permalinkholder.attr("data-cancel-button-title"),"class":"btn pull-left",click:function(){d.$permalinkdialog.dialog("close")}}]}),!1}),d.options.attachmentsEnabled>0&&d.$element.concreteConversationAttachments(d),a(".dropdown-toggle").dropdown()},handlePostError:function(a,b){b||(b=[c.Unspecified_error_occurred]),this.publish("conversationPostError",{form:a,messages:b})},deleteMessage:function(d){var e=this;e.publish("conversationBeforeDeleteMessage",{msgID:d});var f=[{name:"cnvMessageID",value:d}];a.ajax({type:"post",data:f,url:CCM_TOOLS_PATH+"/conversations/delete_message",success:function(b){var c=a("div[data-conversation-message-id="+d+"]");c.length&&c.after(b).remove(),e.updateCount(),e.$deletedialog.dialog&&e.$deletedialog.dialog("close"),e.publish("conversationDeleteMessage",{msgID:d})},error:function(a){e.publish("conversationDeleteMessageError",{msgID:d,error:arguments}),b.alert(c.Error_deleting_message)}})},editMessage:function(b){var c=this,d=[{name:"cnvMessageID",value:b},{name:"cID",value:this.options.cID},{name:"blockAreaHandle",value:this.options.blockAreaHandle},{name:"bID",value:this.options.blockID}];a.ajax({type:"post",data:d,url:CCM_TOOLS_PATH+"/conversations/edit_message",success:function(d){var e=a("div[data-conversation-message-id="+b+"]"),f=e;e.after(d).remove(),a(".ccm-conversation-attachment-container").hide(),a(".ccm-conversation-edit-message .ccm-conversation-attachment-toggle").off("click.cnv").on("click.cnv",function(b){b.preventDefault(),a(".ccm-conversation-edit-message .ccm-conversation-attachment-container").toggle()}),c.$editMessageHolder=c.$element.find("div.ccm-conversation-edit-message"),c.$element.concreteConversationAttachments(c),a("button.cancel-update").on("click.cnv",function(){a(".ccm-conversation-edit-message").replaceWith(f)})},error:function(a){c.publish("conversationEditMessageError",{msgID:b,error:arguments})}})},flagMessage:function(d){var e=this;e.publish("conversationBeforeFlagMessage",{msgID:d});var f=[{name:"cnvMessageID",value:d}];a.ajax({type:"post",data:f,url:CCM_TOOLS_PATH+"/conversations/flag_message",success:function(b){var c=a("div[data-conversation-message-id="+d+"]");c.length&&c.after(b).remove(),e.updateCount(),e.publish("conversationFlagMessage",{msgID:d})},error:function(a){e.publish("conversationFlagMessageError",{msgID:d,error:arguments}),b.alert(c.Error_flagging_message)}})},addMessageFromJSON:function(b,c){var d=this;d.publish("conversationBeforeAddMessageFromJSON",{json:c,form:b});var e=""!=d.options.posttoken?1:0,f=[{name:"cnvMessageID",value:c.cnvMessageID},{name:"enablePosting",value:e},{name:"displayMode",value:d.options.displayMode},{name:"enableCommentRating",value:d.options.enableCommentRating}];a.ajax({type:"post",data:f,url:CCM_TOOLS_PATH+"/conversations/message_detail",success:function(e){var f=a("div[data-conversation-message-id="+c.cnvMessageParentID+"]");if(f.length){f.after(e),d.$replyholder.appendTo(d.$element),d.$replyholder.hide(),d.$replyholder.find(".conversation-editor").val("");try{d.$replyholder.find(".redactor_conversation_editor_"+d.options.cnvID).redactor("set","")}catch(g){}}else{"date_desc"==d.options.orderBy?d.$messages.prepend(e):d.$messages.append(e),d.$element.find(".ccm-conversation-no-messages").hide(),d.$newmessageform.find(".conversation-editor").val("");try{d.$newmessageform.find(".redactor_conversation_editor_"+d.options.cnvID).redactor("set","")}catch(g){}}d.publish("conversationAddMessageFromJSON",{json:c,form:b}),d.updateCount();var h=a("a#cnv"+d.options.cnvID+"Message"+c.cnvMessageID).offset();a(".dropdown-toggle").dropdown(),a("html, body").animate({scrollTop:h.top},800,"linear")}})},updateMessageFromJSON:function(b,c){var d=this,e=""!=d.options.posttoken?1:0,f=[{name:"cnvMessageID",value:c.cnvMessageID},{name:"enablePosting",value:e},{name:"displayMode",value:d.options.displayMode},{name:"enableCommentRating",value:d.options.enableCommentRating}];a.ajax({type:"post",data:f,url:CCM_TOOLS_PATH+"/conversations/message_detail",success:function(b){var d=a("div[data-conversation-message-id="+c.cnvMessageID+"]");d.after(b).remove(),a(".dropdown-toggle").dropdown()}})},updateCount:function(){var a=this;a.publish("conversationBeforeUpdateCount"),a.$messagecnt.load(CCM_TOOLS_PATH+"/conversations/count_header",{cnvID:a.options.cnvID},function(){a.publish("conversationUpdateCount")})},submitForm:function(b){var c=this;c.publish("conversationBeforeSubmitForm");var d=b.closest("form");b.prop("disabled",!0),d.parent().addClass("ccm-conversation-form-submitted");var e=d.serializeArray(),f=b.attr("data-post-parent-id");e.push({name:"token",value:c.options.posttoken},{name:"cnvID",value:c.options.cnvID},{name:"cnvMessageParentID",value:f},{name:"enableRating",value:f}),a.ajax({dataType:"json",type:"post",data:e,url:CCM_TOOLS_PATH+"/conversations/add_message",success:function(b){return b?b.error?(c.handlePostError(d,b.errors),!1):(a(".preview.processing").each(function(){a('input[rel="'+a(this).attr("rel")+'"]').remove()}),a("form.dropzone").each(function(){var b=a(this).data("dropzone");a.each(b.files,function(a,c){b.removeFile(c)})}),c.addMessageFromJSON(d,b),void c.publish("conversationSubmitForm",{form:d,response:b})):(c.handlePostError(d),!1)},error:function(a){return c.handlePostError(d),!1},complete:function(a){b.prop("disabled",!1),d.parent().closest(".ccm-conversation-form-submitted").removeClass("ccm-conversation-form-submitted")}})},submitUpdateForm:function(b){var c=this;c.publish("conversationBeforeSubmitForm");var d=b.closest("form");b.prop("disabled",!0),d.parent().addClass("ccm-conversation-form-submitted");var e=d.serializeArray(),f=b.attr("data-post-message-id");e.push({name:"token",value:c.options.posttoken},{name:"cnvMessageID",value:f}),a.ajax({dataType:"json",type:"post",data:e,url:CCM_TOOLS_PATH+"/conversations/update_message",success:function(b){return b?b.error?(c.handlePostError(d,b.errors),!1):(a(".preview.processing").each(function(){a('input[rel="'+a(this).attr("rel")+'"]').remove()}),c.updateMessageFromJSON(d,b),void c.publish("conversationSubmitForm",{form:d,response:b})):(c.handlePostError(d),!1)},error:function(a){return c.handlePostError(d),!1},complete:function(a){b.prop("disabled",!1),d.parent().closest(".ccm-conversation-form-submitted").removeClass("ccm-conversation-form-submitted")}})},tool:{setCaretPosition:function(a,b){if(null!=a)if(a.createTextRange){var c=a.createTextRange();c.move("character",b),c.select()}else a.selectionStart?(a.focus(),a.setSelectionRange(b,b)):a.focus()},getCaretPosition:function(a){if(a.selectionStart)return a.selectionStart;if(document.selection){a.focus();var b=document.selection.createRange();if(null==b)return 0;var c=a.createTextRange(),d=c.duplicate();return c.moveToBookmark(b.getBookmark()),d.setEndPoint("EndToStart",c),d.text.length}return 0},testMentionString:function(a){return/^@[a-z0-9]+$/.test(a)},getMentionMatches:function(a,b){return b.filter(function(b){return b.indexOf(a)>=0})},isSameConversation:function(a,b){return a.options.blockID===b.options.blockID&&a.options.cnvID===b.options.cnvID},MentionUser:function(a){this.getName=function(){return a}}}}}(jQuery,window),function(a,b){var c={Too_many_files:"Too many files",Invalid_file_extension:"Invalid file extension",Max_file_size_exceeded:"Max file size exceeded",Error_deleting_attachment:"Something went wrong while deleting this attachment, please refresh and try again.",Confirm_remove_attachment:"Remove this attachment?"},d={init:function(b){var d=b;return d.$element.on("click.cnv","a[data-toggle=conversation-reply]",function(){a(".ccm-conversation-wrapper").concreteConversationAttachments("clearDropzoneQueues")}),d.$element.on("click.cnv","a.attachment-delete",function(b){b.preventDefault(),a(this).concreteConversationAttachments("attachmentDeleteTrigger",d)}),d.$editMessageHolder&&!d.$editMessageHolder.find(".dropzone").attr("data-dropzone-applied")&&d.$editMessageHolder.find(".dropzone").not('[data-drozpone-applied="true"]').dropzone({url:CCM_TOOLS_PATH+"/conversations/add_file",success:function(b,c){var e=this;a(b.previewTemplate).click(function(){e.removeFile(b),a('input[rel="'+a(this).attr("rel")+'"]').remove()});var f=JSON.parse(c);if(f.error){var g=a('.preview.processing[rel="'+f.timestamp+'"]').closest("form");d.handlePostError(g,[f.error]),a('.preview.processing[rel="'+f.timestamp+'"]').remove(),g.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){a(this).html("")})}else a(this.element).closest("div.ccm-conversation-edit-message").find("form.aux-reply-form").append('<input rel="'+f.timestamp+'" type="hidden" name="attachments[]" value="'+f.id+'" />')},accept:function(b,e){var f=[],g=this.files.length;d.options.maxFiles>0&&g>d.options.maxFiles&&f.push(c.Too_many_files);var h=d.options.fileExtensions.split(",");if(b.name.split(".").pop().toLowerCase()&&-1==h.indexOf(b.name.split(".").pop().toLowerCase())&&""!=h&&f.push(c.Invalid_file_extension),d.options.maxFileSize>0&&b.size>1e6*d.options.maxFileSize&&f.push(c.Max_file_size_exceeded),f.length>0){var i=this;a('input[rel="'+a(b.previewTemplate).attr("rel")+'"]').remove();var j=a(b.previewTemplate).parent(".dropzone");i.removeFile(b),d.handlePostError(j,f),j.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){a(this).html("")}),g=-1,e("error")}else e()},sending:function(b,c,e){a(b.previewTemplate).attr("rel",(new Date).getTime()),e.append("timestamp",a(b.previewTemplate).attr("rel")),e.append("tag",a(d.$editMessageHOlder).parent("div").attr("rel")),e.append("fileCount",a(d.$editMessageHolder).find('[name="attachments[]"]').length)},init:function(){a(this.element).data("dropzone",this)}}),d.$newmessageform.dropzone&&!a(d.$newmessageform).attr("data-dropzone-applied")&&(d.$newmessageform.dropzone({accept:function(b,e){var f=[],g=this.files.length;d.options.maxFiles>0&&g>d.options.maxFiles&&f.push(c.Too_many_files);var h=d.options.fileExtensions.split(",");if(b.name.split(".").pop().toLowerCase()&&-1==h.indexOf(b.name.split(".").pop().toLowerCase())&&""!=h&&f.push(c.Invalid_file_extension),d.options.maxFileSize>0&&b.size>1e6*d.options.maxFileSize&&f.push(c.Max_file_size_exceeded),f.length>0){var i=this;a('input[rel="'+a(b.previewTemplate).attr("rel")+'"]').remove();var j=a(b.previewTemplate).parent(".dropzone");i.removeFile(b),d.handlePostError(j,f),j.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){a(this).html("")}),g=-1,e("error")}else e()},url:CCM_TOOLS_PATH+"/conversations/add_file",success:function(b,c){var e=this;a(b.previewTemplate).click(function(){a('input[rel="'+a(this).attr("rel")+'"]').remove(),e.removeFile(b)});var f=JSON.parse(c);if(f.error){var g=a('.preview.processing[rel="'+f.timestamp+'"]').closest("form");d.handlePostError(g,[f.error]),a('.preview.processing[rel="'+f.timestamp+'"]').remove(),g.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){a(this).html("")})}else a('div[rel="'+f.tag+'"] form.main-reply-form').append('<input rel="'+f.timestamp+'" type="hidden" name="attachments[]" value="'+f.id+'" />')},sending:function(b,c,e){a(b.previewTemplate).attr("rel",(new Date).getTime()),e.append("timestamp",a(b.previewTemplate).attr("rel")),e.append("tag",a(d.$newmessageform).parent("div").attr("rel")),e.append("fileCount",this.files.length)},init:function(){a(this.element).data("dropzone",this)}}),a(d.$newmessageform).attr("data-dropzone-applied","true")),a(d.$replyholder.find(".dropzone")).attr("data-dropzone-applied")||d.$replyholder.find(".dropzone").not('[data-drozpone-applied="true"]').dropzone({url:CCM_TOOLS_PATH+"/conversations/add_file",success:function(b,c){var e=this;a(b.previewTemplate).click(function(){e.removeFile(b),a('input[rel="'+a(this).attr("rel")+'"]').remove()});var f=JSON.parse(c);if(f.error){var g=a('.preview.processing[rel="'+f.timestamp+'"]').closest("form");d.handlePostError(g,[f.error]),a('.preview.processing[rel="'+f.timestamp+'"]').remove(),g.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){a(this).html("")})}else a(this.element).closest("div.ccm-conversation-add-reply").find("form.aux-reply-form").append('<input rel="'+f.timestamp+'" type="hidden" name="attachments[]" value="'+f.id+'" />')},accept:function(b,e){var f=[],g=this.files.length;d.options.maxFiles>0&&g>d.options.maxFiles&&f.push(c.Too_many_files);var h=d.options.fileExtensions.split(",");if(b.name.split(".").pop().toLowerCase()&&-1==h.indexOf(b.name.split(".").pop().toLowerCase())&&""!=h&&f.push(c.Invalid_file_extension),d.options.maxFileSize>0&&b.size>1e6*d.options.maxFileSize&&f.push(c.Max_file_size_exceeded),f.length>0){var i=this;a('input[rel="'+a(b.previewTemplate).attr("rel")+'"]').remove();var j=a(b.previewTemplate).parent(".dropzone");i.removeFile(b),d.handlePostError(j,f),j.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){a(this).html("")}),g=-1,e("error")}else e()},sending:function(b,c,e){a(b.previewTemplate).attr("rel",(new Date).getTime()),e.append("timestamp",a(b.previewTemplate).attr("rel")),e.append("tag",a(d.$newmessageform).parent("div").attr("rel")),e.append("fileCount",a(d.$replyHolder).find('[name="attachments[]"]').length)},init:function(){a(this.element).data("dropzone",this)}}),a(d.$replyholder.find(".dropzone")).attr("data-dropzone-applied","true"),a.each(a(this),function(b,c){a(this).find(".ccm-conversation-attachment-container").each(function(){a(this).is(":visible")&&a(this).toggle()})})},attachmentDeleteTrigger:function(d){var e=d,f=a(this);return e.$attachmentdeletetdialog=e.$attachmentdeleteholder.clone(),e.$attachmentdeletetdialog.dialog?e.$attachmentdeletetdialog.dialog({modal:!0,dialogClass:"ccm-conversation-dialog",title:e.$attachmentdeletetdialog.attr("data-dialog-title"),buttons:[{text:e.$attachmentdeleteholder.attr("data-cancel-button-title"),"class":"btn pull-left",click:function(){e.$attachmentdeletetdialog.dialog("close")}},{text:e.$attachmentdeleteholder.attr("data-confirm-button-title"),"class":"btn pull-right btn-danger",click:function(){a(this).concreteConversationAttachments("deleteAttachment",{cnvMessageAttachmentID:f.attr("rel"),cnvObj:e,dialogObj:e.$attachmentdeletetdialog})}}]}):b.confirm(c.Confirm_remove_attachment)&&a(this).concreteConversationAttachments("deleteAttachment",{cnvMessageAttachmentID:f.attr("rel"),cnvObj:e,dialogObj:e.$attachmentdeletetdialog}),!1},clearDropzoneQueues:function(){a(".preview.processing").each(function(){a('input[rel="'+a(this).attr("rel")+'"]').remove()}),a("form.dropzone").each(function(){var b=a(this).data("dropzone");a.each(b.files,function(a,c){b.removeFile(c)})})},deleteAttachment:function(d){var e=d.cnvMessageAttachmentID,f=d.cnvObj,g=d.dialogObj,h=[{name:"cnvMessageAttachmentID",value:e}];a.ajax({type:"post",data:h,url:CCM_TOOLS_PATH+"/conversations/delete_file",success:function(b){var c=JSON.parse(b);a('p[rel="'+c.attachmentID+'"]').parent(".attachment-container").fadeOut(300,function(){a(this).remove()}),g.dialog&&(g.dialog("close"),f.publish("conversationDeleteAttachment",{cnvMessageAttachmentID:e}))},error:function(a){f.publish("conversationDeleteAttachmentError",{cnvMessageAttachmentID:e,error:arguments}),b.alert(c.Error_deleting_attachment)}})}};a.fn.concreteConversationAttachments=function(b){return d[b]?d[b].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof b&&b?void a.error("Method "+b+" does not exist on concreteConversationAttachments"):d.init.apply(this,arguments)},a.fn.concreteConversationAttachments.localize=function(b){a.extend(!0,c,b)}}(jQuery,window);